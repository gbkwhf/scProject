<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2017/10/30
 * Time: 16:14
 */

namespace App\Http\Controllers\SecondExploit;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Http\Requests;


class GoodsController extends Controller{

    //根据商品扩展id获取商品详情
    public function getGoodsExtendInfo(Request $request)
    {
    
    	
    	$url='http://'.$_SERVER['SERVER_NAME'];
    	
 

        $validator = $this->setRules([
            'ss' => 'required|string',
            'ext_id' => 'required', 
        	'page' => 'string',
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);
        $start=$request->page<=1?0:(($request->page)-1)*10;
    	
   
    	$base_info=\App\GoodsExtendModel::where('ys_goods_extend.id',$request->ext_id)
    			->leftjoin('ys_goods','ys_goods.id','=','ys_goods_extend.goods_id')
    			->select('ys_goods.id as g_id','ys_goods_extend.id as ext_id','ys_goods_extend.name as goods_name','ys_goods_extend.price','ys_goods_extend.market_price','ys_goods_extend.rebate_amount','ys_goods.shipping_price','ys_goods.sales','ys_goods.content','ys_goods.supplier_id as store_id','ys_goods.spec_name','ys_goods.spec_value','ys_goods.goods_gift','ys_goods.use_score')
    			->first();
    	$base_info['content']=formatContent($base_info->content);
    	$base_info['goods_image']=\App\GoodsImageModel::where('goods_id',$base_info->g_id)->selectRaw("concat('".$url."',ys_goods_image.image) as image")->get();
    	$extend_info=\App\GoodsExtendModel::where('ys_goods_extend.goods_id',$base_info->g_id)->get();
    	
   
    	
    	$spec_name=unserialize($base_info->spec_name);
    	$spec_value=unserialize($base_info->spec_value);
    	
    	$base_info['spec_name']=$spec_name;
    	$base_info['spec_value']=$spec_value;

    	foreach ($extend_info as $val){
    		$a='';
    		$ser_val=unserialize($val['goods_spec']);
    		 
    		//dump($ser_val);
    		foreach ($ser_val as $k=>$v){
    			$a.=$k;
    		}
    		$v_list[$a]['ext_id']=$val->id;
    	}
    	
    	
    	$base_info['comment_list']=\App\OrderGoodsModel::where('ext_id',$request->ext_id)
    		->leftjoin('ys_sub_order','ys_sub_order.id','=','ys_order_goods.sub_id')
    		->leftjoin('ys_base_order','ys_base_order.id','=','ys_sub_order.base_id')
    		->leftjoin('ys_member','ys_base_order.user_id','=','ys_member.user_id')
    		->select('ys_member.name','ys_member.image','ys_base_order.create_time','ys_order_goods.user_comment','ys_order_goods.comment_image')
    		->selectRaw('IF(ys_member.image!="",concat("'.$url.'/api/gxsc/show-ico/",ys_member.image),"")  as image')
    		->selectRaw('IF(comment_image!="",concat("'.$url.'/",comment_image),"")  as comment_image')
			->where('ys_sub_order.receive_state',1)
    		->orderby('ys_order_goods.id','desc')->skip($start)->take(10)->get();
    

    	
    	$base_info['value_list']=$v_list;
    	
//     	dump($spec_name);
//     	dump($spec_value);
//     	dd($base_info);
    	
    	

        return  $this->respond($this->format($base_info));

    }


	//搜索商品
	public function getBannerGoods(Request $request){

		$validator = $this->setRules([
			'banner_id' => 'required|integer',
		])
			->_validate($request->all());
		if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);

		$banner_data=\App\BannerManageModel::where('id',$request->banner_id)->first();
		$ids=explode(',',$banner_data->url);



		$data = \DB::table('ys_goods as a')->leftjoin('ys_goods_image as b','a.id','=','b.goods_id')
			->leftjoin('ys_goods_class as gclass','gclass.id','=','a.class_id')
			->leftjoin('ys_goods_extend as gext','gext.goods_id','=','a.id')
			->select('gext.id as goods_id','gext.name as goods_name','gext.num','gext.price','a.sales','b.image')
			->whereIn('a.id',$ids)
			->where('a.state',1) //0下架1上架
			->groupBy('a.id')
			->orderBy('a.sort','asc')
			->orderBy('a.id','asc')
			->get();

		$result = empty($data) ? [] : $data;
		$http = getenv('HTTP_REQUEST_URL');
		//改变图片链接，使其可以直接访问
		if(!empty($result)){
			foreach($result as $k=>$v){
				$result[$k]->image = empty($v->image) ? "" : $http.$v->image;
			}
		}
		return  $this->respond($this->format($result));
	}

}