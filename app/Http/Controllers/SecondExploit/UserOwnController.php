<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2018/6/29
 * Time: 10:06
 */

namespace App\Http\Controllers\SecondExploit;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Http\Requests;


/**
 * Class UserOwnController
 * @package App\Http\Controllers\SecondExploit
 * 该控制器主要用于完成新版本迭代的一些用户基本功能
 */

class UserOwnController extends  Controller
{

    //1.获取余额(积分)消耗列表
    public function getBillInfo(Request $request)
    {

        $validator = $this->setRules([
            'ss' => 'required|string',
            'page' => 'integer'
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);

        $user_id = $this->getUserIdBySession($request->ss); //获取用户id

        $start = $request->page <= 1 ? 0 : (($request->page) - 1) * 10;//分页


        $data = \DB::table('ys_balance_bill')->select('amount','type','desc','created_at')->where('user_id',$user_id)->orderBy('created_at','desc')->skip($start)->take(10)->get();

        return  $this->respond($this->format($data));


    }

    //2.用户提现申请
    public function drawDepositBal(Request $request)
    {

        $validator = $this->setRules([
            'ss' => 'required|string',
            'money' => 'required'
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);

        $user_id = $this->getUserIdBySession($request->ss); //获取用户id

        if($request->money <1){ //提现金额必须大于1
            return $this->setStatusCode(7003)->respondWithError($this->message);

        }

        //1.首先判断用户可提现余额是否大于等于用户申请提现的金额
        $balance = \DB::table('ys_member')->where('user_id',$user_id)->first()->balance;
        if($balance < $request->money*(1+0.05)){ //可提现余额不足  1102
            return $this->setStatusCode(1102)->respondWithError($this->message);
        }

        //2.单笔金额不超过20000
        if($request->money > 20000){ //7000

            return $this->setStatusCode(7000)->respondWithError($this->message);
        }

        //3.如果有提现中的记录则不在接收请求
        $is_exist = \DB::table('ys_apply_money_toweixin')->where('user_id',$user_id)->where('state',0)->first();
        if(!empty($is_exist)){ //7001

            return $this->setStatusCode(7001)->respondWithError($this->message);
        }

        $date = date("Y-m-d");
        //4.如果多笔提现，则每天累计提现不超过20000
        $list = \DB::table('ys_apply_money_toweixin')->where('user_id',$user_id)->where('state',1)->where('created_at','like',$date.'%')->get();
        $ti_money = 0;
        if(!empty($list)){
              foreach($list as $k=>$v){
                  $ti_money += $v->amount;
              }
        }

        if(($ti_money + $request->money) > 20000){ //7002

            return $this->setStatusCode(7002)->respondWithError($this->message);
        }

        \DB::beginTransaction(); //开启事务
        //5.接下来把申请提现的请求插入库
        $is_true = \DB::table('ys_apply_money_toweixin')->insert([
                    'user_id'=>$user_id,
                    'amount'=>$request->money,
                    'state'=>0,
                    'order_id'=>generatorOrderIdNew(),
                    'open_id'=>$request->ss,
                    'created_at'=>\DB::Raw('now()'),
                    'updated_at'=>\DB::Raw('now()')
        ]);

        $update = \DB::table('ys_member')->where('user_id',$user_id)->update(['balance'=>$balance - $request->money*(1+0.05),'updated_at'=>\DB::Raw('Now()') ]);


        if ($is_true && $update) {
            \DB::commit();
            //测试下家里是否可以操作
            return  $this->respond($this->format([],true));
        }else {
            \DB::rollBack();
            return $this->setStatusCode(9998)->respondWithError($this->message);
        }


    }






}