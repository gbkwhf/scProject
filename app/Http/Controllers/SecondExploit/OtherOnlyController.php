<?php
/**
 * Created by PhpStorm.
 * User: Administrator
 * Date: 2018/4/4
 * Time: 11:07
 */

namespace App\Http\Controllers\SecondExploit;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Http\Requests;


/**
 * Class OtherOnlyController
 * @package App\Http\Controllers\SecondExploit
 * 该控制器主要开发一些功能独立的接口
 */
class OtherOnlyController extends  Controller
{


    //1.发布售后问题咨询
    public function pubAfterConsult(Request $request)
    {
        $validator = $this->setRules([
            'ss' => 'required|string',
            'problem' => 'required|string', //售后咨询的问题
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);

        $user_id = $this->getUserIdBySession($request->ss); //获取用户id


        $insert = \DB::table('ys_after_exchange')->insert([

               'user_id'=>$user_id,
               'user_problem'=>$request->problem,
               'merchant_reply'=>'',
               'created_at'=>\DB::Raw('now()')
        ]);


        if($insert)
            return  $this->respond($this->format([],true));
        else
            return $this->setStatusCode(9998)->respondWithError($this->message);

    }


    //2.获取售后问题咨询列表
    public function getAfterConsultList(Request $request)
    {

        $validator = $this->setRules([
            'ss' => 'required|string',
            'page' => 'integer', //分页页码，默认值为1
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);

        $start = $request->page <= 1 ? 0 : (($request->page) - 1) * 10;//分页
        $data = \DB::table('ys_after_exchange as a')
                 ->leftjoin('ys_member as b','a.user_id','=','b.user_id')
                 ->select('a.*','b.name')
                 ->orderBy('a.id','desc');
         $num = $data->get();
         $data = $data->skip($start)->take(10)->get();


        if($data){

            $result['data'] = $data;
            $result['num']  = count($num);
            return  $this->respond($this->format($result,true));
        }else{
            return $this->setStatusCode(9998)->respondWithError($this->message);
        }

    }


    //3.首页搜索商品
    public function getSarchComList(Request $request)
    {

        $validator = $this->setRules([
            'ss' => 'required|string',
            'search' => 'string', //要搜索的商品列表
            'page'=>'integer',//分页的页码
        ])
            ->_validate($request->all());

        if (!$validator)  return $this->setStatusCode(9999)->respondWithError($this->message);
        $start = $request->page <= 1 ? 0 : (($request->page) - 1) * 10;//分页

        $data = \DB::table('ys_goods as a')
                    ->leftjoin('ys_goods_image as b','a.id','=','b.goods_id')
                    ->select('a.id as goods_id','a.name as goods_name','a.num','a.price','a.sales','b.image')
                    ->where('a.state',1); //0下架1上架

        if(empty($request->search)){
            $data =$data->groupBy('a.id')
                            ->orderBy('a.sort','asc')
                            ->orderBy('a.id','asc')
                            ->skip($start)
                            ->take(10)
                            ->get();

        }else{
            $data =$data->where('a.name','like','%'.$request->search.'%')
                        ->groupBy('a.id')
                        ->orderBy('a.sort','asc')
                        ->orderBy('a.id','asc')
                        ->skip($start)
                        ->take(10)
                        ->get();
        }


        $result = empty($data) ? [] : $data;
        $http = getenv('HTTP_REQUEST_URL');
        //改变图片链接，使其可以直接访问
        if(!empty($result)){
            foreach($result as $k=>$v){
                $result[$k]->image = empty($v->image) ? "" : $http.$v->image;
            }
        }
        return  $this->respond($this->format($result));


    }










}