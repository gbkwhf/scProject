<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<title>修改密码</title>
	    <link rel="stylesheet" href="../css/personal/change_password.css">
	    
	</head>
	<body>
		<div class="container">
			<div class="reginput">
				<div class="inp">
					<div class="inp-name">原密码</div>
					<input type="password" placeholder="请输入原密码" name="old" id="old"/>
					<div class="clearfix"></div>
				</div>
				<div class="inp">
					<div class="inp-name">新密码</div>
					<input type="password" placeholder="请输入新密码" name="new" id="new"/>
					<div class="clearfix"></div>
				</div>
				<div class="inp">
					<div class="inp-name">确认新密码</div>
					<input type="password" placeholder="确认新密码" name="news" id="news"/>
					<div class="clearfix"></div>
				</div>
				<div id="submit" onclick="gosubmit()">提<span style="display: inline-block;width:8px;"></span>交</div>
			</div>
	   </div>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../js/layer/layer.js"></script>
        
	    <script>
	    	sessionArr = getCookie('sessionArr');
	    	if(!sessionArr){
	    		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
	    			window.parent.tologin();
	    		});
	    	}else{
	    		ss=JSON.parse(sessionArr).session;
	    	}
	    	setIframeHeight();

			function gosubmit(){
				
				var old_pas=$('#old').val();
				var new_pas=$('#new').val();
				var news_pas=$('#news').val();
				
				//格式校验
				var checkPwd = testPwd(new_pas,news_pas);
	            var checkOld = testOld(old_pas);
	            
	            if(checkOld&&checkPwd){
	            	$.ajax({
	                    type: "POST",
	                    url: commonUrl + 'api/stj/auth/update/password' +versioninfo,
	                    data: {
	                    	'npw': new_pas,
	                    	'opw': old_pas,
	                    	'ss': ss
	                    },
	                    dataType: 'json',
	                    success: function(data){
//	                        console.log(data);
	                        if(data.code==1){
	                            layer.msg('修改密码成功，请重新登录',{time:1000},function(){
	                            	window.parent.removeCookie('sessionArr');
									window.parent.tologin();
	                            });
	                        }else if(data.code=='1011'){
		                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
		                  			window.parent.removec();
		                  			window.parent.tologin();
		                  		});
		                  	}else{
	                            layer.msg(data.msg);
	                        }
	                    }
	                });
	            }
	           
			}
			//校验原始密码
	        function testOld(val){
	            if(!val){
	                layer.tips("请输入原始密码","#old",{tips:[2,'#21c0d5']});
	                $('#old').focus();
	                return false;
	            }else{
	                return true;
	            }
	        }
	        
	        //校验新密码
	        function testPwd(val1,val2){
	        	var reg = /^[a-zA-Z0-9]{8,20}$/;
	            if(!val1){
	                layer.tips("请输入新密码","#new",{tips:[2,'#21c0d5']});
	                $('#new').focus();
	                return false;
	            }else if(!val2){
	                layer.tips("请确认新密码","#news",{tips:[2,'#21c0d5']});
	                $('#news').focus();
	                return false;
	            }else if(val1!=val2){
	                layer.tips("两次密码不一致","#news",{tips:[2,'#21c0d5']});
	                $('#news').focus();
	                return false;
	            }else if(!reg.test(val1)){
	            	layer.tips("密码由8-20位字母,数字组成","#new",{tips:[2,'#21c0d5']});
			        return false;
			    }else{
	                return true;
	            }
	        }
	    	//iframe自适应高度
			function getDocHeight(doc) {
			    doc = doc || document;
			    var body = doc.body, html = doc.documentElement;
			    var height = Math.max( body.scrollHeight, body.offsetHeight, 
			        html.clientHeight, html.scrollHeight, html.offsetHeight );
			    return height;
			}
			function setIframeHeight() {
			    var ifrm = window.parent.document.getElementById("ifrm");
			    var doc = ifrm.contentDocument? ifrm.contentDocument: 
			        ifrm.contentWindow.document;
			    ifrm.style.visibility = 'hidden';
			    ifrm.style.height = "10px"; 
			    ifrm.style.height = getDocHeight( doc ) + "px";
			    ifrm.style.visibility = 'visible';
			}
		    
	    </script>
	</body>
</html>
