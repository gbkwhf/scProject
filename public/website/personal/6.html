<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<title>个人资料</title>
	    <link rel="stylesheet" href="../css/personal/6.css">
	    <style>
	    	
	    </style>
	</head>
	<body>
		<div class="container">
			<!--<div class="reg">
				<div class="reginput">
					<div class="inp">
						<div class="inp-name">姓名</div>
						<input type="text" placeholder="您的姓名" name="name" id="name"/>
						<div class="clearfix"></div>
					</div>
					<div class="inp">
						<div class="inp-name">修改头像</div>
						<div class="uploadbox" id="" org_img="">
	                    	<input class="filetest"  onchange="changefile(this)" type="file" accept="image/*" />
	                    	<span>上传</span>
	                    </div>
						<div class="clearfix"></div>
					</div>
					<div class="inp" id="choose1">
						<div class="inp-name">性别</div>
						<input type="text" class="select" placeholder="请选择" name="gender" id="gender" readonly/>
						<div class="selist">
							<p>男</p>
						  	<p>女</p>
						</div>
						<div class="clearfix"></div>
					</div>
					<div class="inp">
						<div class="inp-name">出生日期</div>
						<input type="text" placeholder="请选择" name="date" id="date" readonly/>
						<div class="clearfix"></div>
					</div>
					<div class="inp">
						<div class="inp-name">所在地区</div>
						<textarea placeholder="请输入您的详细地址" name="addr" id="addr"></textarea>
						<div class="clearfix"></div>
					</div>
					<div class="inp">
						<div class="inp-name">工作地址</div>
						<textarea type="password" placeholder="请输入您的工作地址" name="work_addr" id="work_addr"></textarea>
						<div class="clearfix"></div>
					</div>
					<div id="submit">提<span style="display: inline-block;width:8px;"></span>交</div>
				</div>
				<!--二维码-->
				<!--<div class="codePas">
					<div class="qrcode"></div>
					<p>二维码名片</p>
					<div class="changePas">修<span style="display: inline-block;width:5px;"></span>改<span style="display: inline-block;width:5px;"></span>密<span style="display: inline-block;width:5px;"></span>码</div>
				</div>
				<div class="clearfix"></div>
			</div>-->
	   </div>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../js/layer/layer.js"></script>
		<script type="text/javascript" src="../js/jquery.qrcode.min.js"></script>
		
		<script src="../js/mobiscroll/js/mobiscroll.core-2.5.2.js" type="text/javascript"></script>
		<script src="../js/mobiscroll/js/mobiscroll.core-2.5.2-zh.js" type="text/javascript"></script>

		<link href="../js/mobiscroll/css/mobiscroll.core-2.5.2.css" rel="stylesheet" type="text/css" />
		<link href="../js/mobiscroll/css/mobiscroll.animation-2.5.2.css" rel="stylesheet" type="text/css" />
		<script src="../js/mobiscroll/js/mobiscroll.datetime-2.5.1.js" type="text/javascript"></script>
		<script src="../js/mobiscroll/js/mobiscroll.datetime-2.5.1-zh.js" type="text/javascript"></script>
		<script src="../js/mobiscroll/js/mobiscroll.android-ics-2.5.2.js" type="text/javascript"></script>
		<link href="../js/mobiscroll/css/mobiscroll.android-ics-2.5.2.css" rel="stylesheet" type="text/css" />
		
		<script src="../js/lib/exif.js" type="text/javascript"></script>
        <script src="../js/lib/mobileFix.mini.js" type="text/javascript"></script>
        <script src="../js/lrz.js" type="text/javascript"></script>
        
	    <script>
	    	sessionArr = getCookie('sessionArr');
	    	if(!sessionArr){
	    		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
	    			window.parent.tologin();
	    		});
	    	}else{
	    		ss=JSON.parse(sessionArr).session;
	    	}
	    	setIframeHeight();
	    	layer.load(2);
	    	readPersInfo();
	    	function readPersInfo(){
	    		$.ajax({
			    	type:'POST',
			    	url:commonUrl + 'api/stj/user/profile'+versioninfo,
			    	data:{
			    		'ss':ss
			    	},
			    	dataType: 'json',
			    	success:function(data){
			    		layer.closeAll();
			    		console.log(data);
	                    if(data.code == 1){
	                    	sex={
	                    		'0':'未选择',
	                    		'1':'男',
	                    		'2':'女'
	                    	}
	                    	grade={
	                    		'1':'普通会员',
	                    		'2':'红卡会员',
	                    		'3':'金卡会员',
	                    		'4':'白金卡会员',
	                    		'5':'黑卡会员'
	                    	}
	                    	if(data.result[0].thumbnail_image_url){
	                    		thumbnail_image_url=data.result[0].thumbnail_image_url;
	                    	}else{
	                    		thumbnail_image_url='../images/personal-center/default.png';
	                    	}
	                    	if(!data.result[0].sex_id){
	                    		$('#gender').val('');
	                    	}
	                    	html='';
	                    	html+='<div class="reg">';
	                    	html+='	<div class="reginput">';
	                    	html+='		<div class="inp">';
	                    	html+='			<div class="inp-name">姓名</div>';
	                    	html+='			<input type="text" placeholder="您的姓名" name="name" id="name" value="'+data.result[0].name+'" onkeyup="filter()" maxlength="6"/>';
	                    	html+='			<div class="clearfix"></div>';
	                    	html+='		</div>';
	                    	html+='		<div class="inp">';
	                    	html+='			<div class="inp-name">会员类型</div>';
	                    	html+='			<input type="text" value="'+grade[data.result[0].grade]+'" readonly style="border:none;"/>';
	                    	html+='			<div class="clearfix"></div>';
	                    	html+='		</div>';
	                    	html+='		<div class="inp">';
	                    	html+='			<div class="inp-name">会员编号</div>';
	                    	html+='			<input type="text" value="'+data.result[0].vip_code+'" readonly style="border:none;"/>';
	                    	html+='			<div class="clearfix"></div>';
	                    	html+='		</div>';
	                    	html+='		<div class="inp">';
							html+='			<div class="inp-name">修改头像</div>';
							html+='			<div class="uploadbox" id="" org_img="" style="background-image:url('+thumbnail_image_url+')">';
	                    	html+='				<input class="filetest"  onchange="changefile(this)" type="file" accept="image/*" />';
	                    	html+='				<span>上传</span>';
	                   		html+='			</div>'; 
							html+='			<div class="clearfix"></div>';
							html+='		</div>';
							html+='		<div class="inp" id="choose1">';
							html+='			<div class="inp-name">性别</div>';
							html+='			<input type="text" class="select" placeholder="请选择" name="gender" id="gender" readonly value="'+sex[data.result[0].sex_id]+'"/>';
							html+='			<div class="selist">';
							html+='				<p>未选择</p>';
							html+='				<p>男</p>';
						  	html+='				<p>女</p>';
							html+='			</div>';
							html+='			<div class="clearfix"></div>';
							html+='		</div>';
							html+='		<div class="inp">';
							html+='			<div class="inp-name">出生日期</div>';
							html+='			<input type="text" placeholder="请选择" name="date" id="date" value="'+(data.result[0].birthday).slice(0,10)+'"/>';
							html+='			<div class="clearfix"></div>';
							html+='		</div>';
							html+='		<div class="inp">';
							html+='			<div class="inp-name">所在地区</div>';
							html+='			<textarea placeholder="请输入您的详细地址" name="addr" id="addr" style="resize:none" maxlength="30">'+data.result[0].live_place+'</textarea>';
							html+='			<div class="clearfix"></div>';
							html+='		</div>';
							html+='		<div class="inp">';
							html+='			<div class="inp-name">工作地址</div>';
							html+='			<textarea type="password" placeholder="请输入您的工作地址" name="work_addr" id="work_addr" style="resize:none" maxlength="30">'+data.result[0].work_address+'</textarea>';
							html+='			<div class="clearfix"></div>';
							html+='		</div>';
							html+='		<div id="submit" onclick="submit()">提<span style="display: inline-block;width:8px;"></span>交</div>';
							html+='	</div>';
							html+='	<div class="codePas">';
							html+='		<div class="qrcode"><img src="'+data.result[0].qc_code+'" /></div>';
							html+='		<p>二维码名片</p>';
							html+='		<div class="changePas" onclick="location.href=\'change_password.html\'">修<span style="display: inline-block;width:5px;"></span>改<span style="display: inline-block;width:5px;"></span>密<span style="display: inline-block;width:5px;"></span>码</div>';
							html+='	</div>';
							html+='	<div class="clearfix"></div>';
							html+='</div>';
							$('.container').html(html);
							
							//生成二维码
//							$('.qrcode').qrcode({
//	                            width: 200, //宽度
//	                            height:200, //高度
//	                            text: data.result[0].qc_code //任意内容
//	                        });
	                        
							//选择性别
					    	$('#gender').click(function(){
								if($(this).hasClass('select2')){
									$(this).removeClass('select2');
									$(this).next('.selist').hide();
								}else{
									$(this).addClass('select2');
									$(this).next('.selist').show();
								}
							});
							$('.selist p').click(function(){
								var select_val = $(this).text();
								$(this).parent().prev('.select').val(select_val);
								$(this).parent().hide();
								$(this).parent().prev().removeClass('select2');
							});
							$("#date").val(''+(data.result[0].birthday).slice(0,10)+'').scroller('destroy').scroller($.extend(opt['date'], opt['default']));
	                  	}else if(data.code=='1011'){
	                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
	                  			window.parent.removec();
	                  			window.parent.tologin();
	                  		});
	                  	}else{
	                  		layer.msg(data.msg);
	                  	}
	                }
	           	});
	    	}
	    	function changefile(obj) {
	            filetest = obj;
	            layer.load(2, {time: 7*1000});
	            lrz(filetest.files[0], {width: 400,quality:1}, function (result) {
	                // 你需要的数据都在这里，可以以字符串的形式传送base64给服务端转存为图片。
	                submitData={
	                    base64_string:result.base64
	                };
	                //提交
	                $.ajax({
	                    type: "POST",
	                    url: commonUrl + 'wxsite/upload.php' + versioninfo,
	                    data: submitData,
	                    dataType: 'json',
	                    success: function(data){
//	                        console.log(data);
	                        if(data.code==1){
	                            layer.closeAll();
	                            img_url = 'http://'+data.data;
//	                            console.log(img_url);
								//上传图片
					            $.ajax({
							    	type:'POST',
							    	url:commonUrl + 'api/stj/user/update/updateuser_img'+versioninfo,
							    	data:{
							    		'img_url':img_url,
							    		'ss':ss
							    	},
							    	success:function(data){
							    		console.log(data);
					                    if(data.code == 1){
								                    	
					                  	}else if(data.code=='1011'){
					                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
					                  			window.parent.removec();
					                  			window.parent.tologin();
					                  		});
					                  	}else{
					                  		layer.msg(data.msg);
					                  	}
					                }
					           	});
	                            $(filetest).parent(".uploadbox").css({
	                                "background-image":"url('http://"+data.data+"')",
	                                "background-size":"contain"
	                            });   
	                        }else{
	                            layer.msg(data.msg);
	                        }
	                    }
	                });
	            });
	        }
	    	function submit(){
	    		var birthday=$('#date').val();
	    		var live_place=$('#addr').val();
	    		var name=$('#name').val();
	    		var work_addr=$('#work_addr').val();
	    		var gender=$('#gender').val();
	    		if(gender=='男'){
	    			sex_id = '1';
	    		}else if(gender=='女'){
	    			sex_id = '2';
	    		}else{
	    			sex_id='0';
	    		}
	    		if(name){
	    			$.ajax({
		                type: "POST",
		                url: commonUrl + 'api/stj/user/update/updateProfile' + versioninfo,
		                data: {
		                	'ss': ss,
		                	'birthday': birthday,
		                	'live_place': live_place,
		                	'name': name,
		                	'sex_id': sex_id,
		                	'work_address': work_addr
		                },
		                dataType: 'json',
		                success: function(data){
		                    if(data.code==1){
		                        layer.msg('提交成功',{time:1000},function(){
		                        	readPersInfo();
		                        });
		                    }else if(data.code=='1011'){
		                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
		                  			window.parent.removec();
		                  			window.parent.tologin();
		                  		});
		                  	}else{
		                        layer.msg(data.msg);
		                    }
		                }
		            });
	    		}else{
	    			layer.msg('姓名不能为空');
	    		}
	    	}
			//日期选择
			var currYear = (new Date()).getFullYear();
			var opt = {};
			opt.date = {
				preset: 'date'
			};
			opt.default = {
				theme: 'android-ics light', //皮肤样式
				display: 'modal', //显示方式 
				mode: 'scroller', //日期选择模式
				lang: 'zh',
				startYear: currYear - 120, //开始年份
//				endYear: currYear  //结束年份
				maxDate: new Date()	//从当前年，当前月，当前日结束

			};
			
	    	//iframe自适应高度
			function getDocHeight(doc) {
			    doc = doc || document;
			    var body = doc.body, html = doc.documentElement;
			    var height = Math.max( body.scrollHeight, body.offsetHeight, 
			        html.clientHeight, html.scrollHeight, html.offsetHeight );
			    return height;
			}
			function setIframeHeight() {
			    var ifrm = window.parent.document.getElementById("ifrm");
			    var doc = ifrm.contentDocument? ifrm.contentDocument: 
			        ifrm.contentWindow.document;
			    ifrm.style.visibility = 'hidden';
			    ifrm.style.height = "10px"; 
			    ifrm.style.height = getDocHeight( doc ) + "px";
			    ifrm.style.visibility = 'visible';
			}
	    	function filter(){
				var name=$("#name").val();
				name=name.replace(/([^0-9a-zA-Z\u4e00-\u9fa5]+)$/,'');//英文字母、数字、中文
				$("#name").val(name);
			}
		    
	    </script>
	</body>
</html>
