<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
	    <meta name="renderer" content="webkit">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
		<title>商品订单列表</title>
	    <link rel="stylesheet" href="../css/personal/4.css">
	    <link rel="stylesheet" href="../css/jquery.page.css">
	    <style>
	    	#page{
	    		position: absolute;
	    		bottom:0;
	    	}
	    </style>
	</head>
	<body>
		<div class="container">
			<table class="medRecordList" cellpadding="0" cellspacing="0" style="visibility: hidden;">
				<tr>
	                <td>商品名称</td>
	                <td class="second">交易时间</td>
	                <td class="third">订单状态</td>
	           	</tr>
			</table>
			<ul class="order-list">
				<!--<li>
					<div class="proImge"><img src="../images/personal-center/product.jpg"></div>
					<div class="proInfo">
						<p class="proNames">茉莉香米泰国茉莉香茉莉香米泰国茉莉香米泰国茉莉香米泰国茉莉香</p>
						<p><span class="price">¥ 1800.00</span><span class="count">*1</span></p>
					</div>
					<div class="time">2016-11-21</div>
					<div class="state">未付款</div>
				</li>-->
			</ul>
			<div id="page" style="visibility: hidden;"></div>
	   </div>
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script type="text/javascript" src="../js/common.js"></script>
		<script type="text/javascript" src="../js/layer/layer.js"></script>
		<script type="text/javascript" src="../js/jquery.page.js"></script>
	    <script>
	   		sessionArr = getCookie('sessionArr');
	   		if(!sessionArr){
	    		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
	    			window.parent.tologin();
	    		});
	    	}else{
	    		ss=JSON.parse(sessionArr).session;
	    	}
	   		orderlist_page=0;
	   		layer.load(2);
		    $.ajax({
		    	type:'POST',
		    	url:commonUrl + 'api/stj/goods/order_list'+versioninfo,
		    	async:false,
		    	data:{
		    		'home':1,
		    		'ss':ss
		    	},
		    	success:function(data){
		    		layer.closeAll();
//		    		console.log(data);
                    if(data.code == 1){
                    	if(data.result.list.length!=0){
                    		orderlist_page=Math.ceil(data.result.count/10);
							$('.medRecordList').css('visibility','visible');
							$('#page').css('visibility','visible');
                    		html='';
                    		for(var i=0;i<data.result.list.length;i++){
                    			id=data.result.list[i].id;      //订单号
                    			image=data.result.list[i].image;
                    			name=data.result.list[i].name;
                    			price=data.result.list[i].price;
                    			num=data.result.list[i].num;
                    			created_at=data.result.list[i].created_at;
                    			state=data.result.list[i].state;
                    			if(state==0){
                    				state="未付款";
                    			}else if(state==1){
                    				state="已付款";
                    			}else if(state==2){
                    				state="已发货";
                    			}
                    			html+='<li id="'+id+'" onclick="toDetail(this);">';
                    			html+='	<div class="proImge"><img src="'+image+'"></div>';
                    			html+='	<div class="proInfo">';
                    			html+='		<p class="proNames">'+name+'</p>';
                    			html+='		<p><span class="price">¥ '+price+'</span><span class="count">数量：'+num+'</span></p>';
                    			html+='	</div>';
                    			html+='	<div class="time">'+created_at+'</div>';
                    			html+='	<div class="state">'+state+'</div>';
                    			html+='</li>';
                    		}
                    		$('.order-list').html(html);
					    	setIframeHeight();
					    	//iframe自适应高度
							function getDocHeight(doc) {
							    doc = doc || document;
							    var body = doc.body, html = doc.documentElement;
							    var height = Math.max( body.scrollHeight, body.offsetHeight, 
							        html.clientHeight, html.scrollHeight, html.offsetHeight );
							    return height;
							}
							function setIframeHeight() {
							    var ifrm = window.parent.document.getElementById("ifrm");
							    var doc = ifrm.contentDocument? ifrm.contentDocument: 
							        ifrm.contentWindow.document;
							    ifrm.style.visibility = 'hidden';
							    ifrm.style.height = "10px"; 
							    ifrm.style.height = getDocHeight( doc ) + "px";
							    ifrm.style.visibility = 'visible';
							}
							proOrder = JSON.stringify(data.result.list);
                            localStorage.setItem("proOrder",proOrder);
                    	}else{
                    		layer.msg('暂无数据');
                    	}
                    	
                  	}else if(data.code=='1011'){
                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
                  			window.parent.removec();
                  			window.parent.tologin();
                  		});
                  	}else{
                  		layer.msg(data.msg);
                  	}
                }
            });
			$("#page").Page({
		        totalPages: orderlist_page,//分页总数
		        liNums: 7,//分页的数字按钮数(建议取奇数)
		        activeClass: 'activP', //active 类样式定义
		        callBack : function(page){
//		          	console.log(page);
		          	ajaxrequest(page);
		        }
      		});
      		pageW=$('#page').width();
      		$('#page').css('left',(680-pageW)/2 + 'px');
      		function ajaxrequest(num){
      			layer.load(2);
				$.ajax({
			    	type:'POST',
			    	url:commonUrl + 'api/stj/goods/order_list'+versioninfo,
			    	data:{
			    		'page':num,
			    		'ss':ss
			    	},
			    	success:function(data){
			    		layer.closeAll();
//			    		console.log(data);
	                    if(data.code == 1){
	                    	proOrder = JSON.stringify(data.result);
                            localStorage.setItem("proOrder",proOrder);
	                    	shows(data);
	                  	}else if(data.code=='1011'){
	                  		layer.msg('该用户登陆数据已过期，请重新登陆',{time:1000},function(){
	                  			window.parent.removec();
	                  			window.parent.tologin();
	                  		});
	                  	}else{
	                  		layer.msg(data.msg);
	                  	}
	                }
	           	});
			}
			function shows(obj){
				html='';
				for(var i=0;i<obj.result.length;i++){
        			id=obj.result[i].id;      //订单号
        			image=obj.result[i].image;
        			name=obj.result[i].name;
        			price=obj.result[i].price;
        			num=obj.result[i].num;
        			created_at=obj.result[i].created_at;
        			state=obj.result[i].state;
        			if(state==0){
        				state="未付款";
        			}else if(state==1){
        				state="已付款";
        			}else if(state==2){
        				state="已发货";
        			}
        			html+='<li id="'+id+'" onclick="toDetail(this);">';
        			html+='	<div class="proImge"><img src="'+image+'"></div>';
        			html+='	<div class="proInfo">';
        			html+='		<p class="proNames">'+name+'</p>';
        			html+='		<p><span class="price">¥ '+price+'</span><span class="count">数量：'+num+'</span></p>';
        			html+='	</div>';
        			html+='	<div class="time">'+created_at+'</div>';
        			html+='	<div class="state">'+state+'</div>';
        			html+='</li>';
        		}
        		$('.order-list').html(html);
        		
        		
        		setIframeHeight();
		    	//iframe自适应高度
				function getDocHeight(doc) {
				    doc = doc || document;
				    var body = doc.body, html = doc.documentElement;
				    var height = Math.max( body.scrollHeight, body.offsetHeight, 
				        html.clientHeight, html.scrollHeight, html.offsetHeight );
				    return height;
				}
				function setIframeHeight() {
				    var ifrm = window.parent.document.getElementById("ifrm");
				    var doc = ifrm.contentDocument? ifrm.contentDocument: 
				        ifrm.contentWindow.document;
				    ifrm.style.visibility = 'hidden';
				    ifrm.style.height = "10px"; 
				    ifrm.style.height = getDocHeight( doc ) + "px";
				    ifrm.style.visibility = 'visible';
				}
			}
            function toDetail(obj){
				sp=obj;
				id=$(sp).attr('id');
//				console.log(id);
				window.location.href='44.html?id='+id;
			}
	    </script>
	</body>
</html>
